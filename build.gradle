apply plugin: 'java'
apply plugin: 'eclipse'

repositories {
    mavenCentral()
}

dependencies {
	compile "org.apache.hadoop:hadoop-core:0.20.2@jar"
	compile "junit:junit:4.8.2@jar"
	compile "commons-logging:commons-logging:1.0.4@jar"
	compile "commons-logging:commons-logging-api:1.0.4@jar"
}

//************* java plugin configuration ********************
sourceCompatibility = 1.6
version = '0.01'
jar {
	manifest {
		attributes("Main-Class": "com.freshbourne.hdfs.index.run.CSV")
	}
}

//************* OWN TASKS ********************

task installTpch << {
	"scripts/install_tpch.sh".execute().text
}
installTpch.description = 'Downloads and installs tpch on linux x86. Requires curl and gcc'


task runJar(dependsOn:jar) << {
	run("hadoop fs -rmr /csv_output")
	run("hadoop fs -put test.csv /test.csv")
	if(run("hadoop jar build/libs/hdfs-indexer-0.01.jar /test.csv").exitValue() != 0)
		throw new RuntimeException("indexer failed");
	
	println "*** RESULTS: ***"
	run("hadoop fs -cat /csv_output/*")
}
runJar.description = 'trys to run the jar in Hadoop'


//************* HELPER METHODS ********************

// run a command with direct process output
def run(command) {
	def process = command.execute()
	process.consumeProcessOutput(System.out, System.err)
	process.waitForOrKill(0)
	return process // use to get exit code et cetera
}
