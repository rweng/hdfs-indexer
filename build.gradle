apply plugin: 'java'
apply plugin: 'eclipse'

repositories {
    mavenCentral()
}

dependencies {
	compile "org.apache.hadoop:hadoop-core:0.20.2@jar"
	compile "junit:junit:4.8.2@jar"
	compile "commons-logging:commons-logging:1.0.4@jar"
	compile "commons-logging:commons-logging-api:1.0.4@jar"
}

task installTpch << {
	"script/install_tpch.sh".execute().text
}
installTpch.description = 'Downloads and installs tpch on linux x86. Requires curl and gcc'


// run a command with direct process output
def run(command) {
	def process = command.execute()
	process.consumeProcessOutput(System.out, System.err)
	process.waitForOrKill(0)
	return process // use to get exit code et cetera
}

jar {
	manifest {
		attributes("Main-Class": "com.freshbourne.hdfs.index.run.CSV")
	}
}

task runJar(dependsOn:jar) << {
	run("hadoop fs -rmr /csv_output")
	if(run("hadoop jar build/libs/hdfs-indexer.jar /test.csv").exitValue() != 0)
		throw new RuntimeException("indexer failed");
	
}
runJar.description = 'trys to run the jar in Hadoop'
